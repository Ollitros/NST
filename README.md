Mainly stolen code for NST.
